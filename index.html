<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📋 Generator Ofert</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="bg-gray-50 text-gray-800">
  <div id="app" class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-4">📋 Generator Ofert</h1>

    <div class="bg-white p-6 rounded-xl shadow mb-6">
      <h2 class="font-semibold text-lg mb-3">1️⃣ Wybierz język</h2>
      <select id="langSelect" class="border rounded-lg p-2">
        <option value="PL">Polski</option>
        <option value="EN">English</option>
        <option value="RO">Română</option>
        <option value="CS">Čeština</option>
      </select>
    </div>

    <div class="bg-white p-6 rounded-xl shadow mb-6">
      <h2 class="font-semibold text-lg mb-3">2️⃣ Wybierz sieć</h2>
      <div id="networks" class="flex flex-wrap gap-3"></div>
      <div id="offerInfo" class="mt-4 text-green-700 font-semibold"></div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow mb-6">
      <h2 class="font-semibold text-lg mb-3">3️⃣ Kolumny w ofercie</h2>
      <div id="columns" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow mb-6">
      <h2 class="font-semibold text-lg mb-3">4️⃣ Dodaj produkty</h2>
      <textarea id="symbolsInput" placeholder="Wklej symbole (po jednym w linii)" class="border w-full rounded-lg p-3 h-32 mb-3"></textarea>
      <button id="addSymbolsBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Dodaj produkty</button>
      <div id="productList" class="mt-4"></div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="font-semibold text-lg mb-3">5️⃣ Generuj ofertę</h2>
      <div class="flex gap-3">
        <button id="pdfBtn" class="flex-1 bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700">📄 PDF</button>
        <button id="excelBtn" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700">📊 Excel</button>
      </div>
    </div>

    <p class="text-center text-gray-500 text-sm mt-8">Generator Ofert v1.0 • Netlify edition</p>
  </div>

  <script>
    const SHEET_ID = '1R3CKABzIXSacr6A5nLmf_DZT9RtfdUVBKZTZNgCG4Zo';
    const API_KEY = 'AIzaSyASZbTomz-sao5jmw9frcWttnS1FvPwky0';

    const app = {
      products: [],
      selectedProducts: [],
      selectedNetwork: null,
      offerNumber: '',
      columns: {
        symbol: true,
        ean: true,
        name: true,
        features: true,
        technical: false,
        complementary: true,
        priceNet: true,
        priceNetNet: false
      }
    };

    // Ładowanie sieci
    async function loadNetworks() {
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sieci?key=${API_KEY}`);
      const data = await res.json();
      const container = document.getElementById("networks");
      data.values.slice(1).forEach(row => {
        const btn = document.createElement("button");
        btn.textContent = row[1];
        btn.className = "px-4 py-2 rounded-lg border hover:bg-gray-100";
        btn.style.borderColor = row[2];
        btn.onclick = () => selectNetwork(row[1], row[2]);
        container.appendChild(btn);
      });
    }

    function selectNetwork(name, color) {
      app.selectedNetwork = name;
      app.offerNumber = `${name}/1/${new Date().toLocaleDateString('pl-PL').replaceAll('.', '')}`;
      document.getElementById("offerInfo").innerHTML =
        `Sieć: <b style="color:${color}">${name}</b><br>Numer oferty: <b>${app.offerNumber}</b>`;
    }

    // Ładowanie produktów
    async function loadProducts(lang = "PL") {
      const sheetName = `Produkty_${lang}`;
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${sheetName}?key=${API_KEY}`);
      const data = await res.json();
      if (!data.values) return alert("Brak danych produktów");
      const [header, ...rows] = data.values;
      app.products = rows.map(r => ({
        symbol: r[0],
        ean: r[1],
        name: r[2],
        features: r[3],
        technical: r[4],
        complementary: r[5],
        priceNet: r[6],
        priceNetNet: r[7]
      }));
    }

    function setupColumns() {
      const cols = {
        symbol: "Symbol",
        ean: "EAN",
        name: "Nazwa",
        features: "Cechy",
        technical: "Dane techniczne",
        complementary: "Komplementacja",
        priceNet: "Cena Netto",
        priceNetNet: "Cena NetNet"
      };
      const container = document.getElementById("columns");
      Object.entries(cols).forEach(([key, label]) => {
        const div = document.createElement("div");
        div.className = "flex items-center space-x-2";
        div.innerHTML = `<input type="checkbox" id="${key}" ${app.columns[key] ? 'checked' : ''} class="w-4 h-4 text-blue-600"><label for="${key}">${label}</label>`;
        container.appendChild(div);
        div.querySelector("input").addEventListener("change", e => app.columns[key] = e.target.checked);
      });
    }

    function addProducts() {
      const symbols = document.getElementById("symbolsInput").value.split(/[\n,;]+/).map(s => s.trim().toUpperCase()).filter(Boolean);
      app.selectedProducts = app.products.filter(p => symbols.includes(p.symbol));
      renderProducts();
    }

    function renderProducts() {
      const div = document.getElementById("productList");
      div.innerHTML = app.selectedProducts.map(p => `<div class='p-2 border-b flex justify-between'><span><b>${p.symbol}</b> - ${p.name}</span><span>${p.priceNet || ''} zł</span></div>`).join('');
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape" });
      doc.setFontSize(16);
      doc.text("Oferta handlowa", 14, 20);
      doc.setFontSize(12);
      doc.text(`Numer: ${app.offerNumber}`, 14, 30);
      doc.text(`Sieć: ${app.selectedNetwork}`, 14, 38);
      let y = 50;
      app.selectedProducts.forEach(p => {
        doc.text(`${p.symbol} - ${p.name} - ${p.priceNet} zł`, 14, y);
        y += 8;
      });
      doc.save(`Oferta_${app.selectedNetwork}.pdf`);
    }

    function generateExcel() {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(app.selectedProducts);
      XLSX.utils.book_append_sheet(wb, ws, "Oferta");
      XLSX.writeFile(wb, `Oferta_${app.selectedNetwork}.xlsx`);
    }

    document.getElementById("addSymbolsBtn").onclick = addProducts;
    document.getElementById("pdfBtn").onclick = generatePDF;
    document.getElementById("excelBtn").onclick = generateExcel;
    document.getElementById("langSelect").onchange = (e) => loadProducts(e.target.value);

    setupColumns();
    loadNetworks();
    loadProducts("PL");
  </script>
</body>
</html>
